<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Detail | Book Rental</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="container">
        <a href="../index.html" class="logo">Book Rental</a>
        <ul class="nav-links" id="navLinks">
          <li><a href="books.html">Books</a></li>
          <li><a href="search.html">Search</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li id="nav-auth"></li>
        </ul>
        <div class="menu-toggle" id="menuToggle">&#9776;</div>
      </div>
    </nav>
  </header>
  <main>
    <section class="container" style="max-width:600px;margin:2rem auto;">
      <div id="bookDetail"></div>
      <div id="bookActions" style="margin-top:2rem;"></div>
    </section>
  </main>
  <footer>
    <div class="container">
      <p>&copy; 2025 Book Rental. All rights reserved.</p>
    </div>
  </footer>
  <script src="../js/app.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    // Get book ID from URL
    function getBookId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Render book detail
    async function renderBookDetail() {
      const bookId = getBookId();
      const bookDetail = document.getElementById('bookDetail');
      const bookActions = document.getElementById('bookActions');
      if (!bookId) {
        bookDetail.innerHTML = '<p style="color:#e74c3c;">Book ID is missing.</p>';
        return;
      }
      window.BookRentalUtils.showLoading();
      try {
        const res = await window.BookRentalAPI.getBookById(bookId);
        const book = res && res.data ? res.data : null;
        if (!book) {
          bookDetail.innerHTML = '<p style="color:#e74c3c;">Book not found.</p>';
          bookActions.innerHTML = '';
          return;
        }
        bookDetail.innerHTML = `
          <div class="feature-card" style="max-width:100%;">
            <h2>${book.title}</h2>
            <p><strong>Author:</strong> ${book.author}</p>
            <p><strong>ISBN:</strong> ${book.isbn}</p>
            <p><strong>Description:</strong> ${book.description || ''}</p>
            <p><strong>Owner:</strong> ${book.user ? book.user.name : 'N/A'}</p>
            <p><strong>Created:</strong> ${window.BookRentalUtils.formatDate(book.created_at)}</p>
            <p><strong>Updated:</strong> ${window.BookRentalUtils.formatDate(book.updated_at)}</p>
          </div>
        `;

        // Show actions if user is owner
        const user = JSON.parse(window.localStorage.getItem('user') || 'null');
        if (user && book.user_id === user.id) {
          bookActions.innerHTML = `
            <button id="editBtn" class="btn-primary" style="margin-right:1rem;">Edit</button>
            <button id="deleteBtn" class="btn-primary" style="background:#e74c3c;color:#fff;">Delete</button>
            <button id="transferBtn" class="btn-primary" style="background:#4e54c8;color:#fff;margin-left:1rem;">Transfer</button>
          `;
          document.getElementById('editBtn').onclick = () => showEditForm(book);
          document.getElementById('deleteBtn').onclick = () => handleDelete(book.id);
          document.getElementById('transferBtn').onclick = () => showTransferForm(book.id);
        } else {
          bookActions.innerHTML = '';
        }
      } catch (err) {
        bookDetail.innerHTML = '<p style="color:#e74c3c;">' + (err.message || 'Failed to load book') + '</p>';
        bookActions.innerHTML = '';
      } finally {
        window.BookRentalUtils.hideLoading();
      }
    }

    // Show edit form
    function showEditForm(book) {
      const bookDetail = document.getElementById('bookDetail');
      bookDetail.innerHTML = `
        <form id="editBookForm" class="form-card">
          <h2>Edit Book</h2>
          <div class="form-group">
            <label>Title</label>
            <input type="text" id="editTitle" value="${book.title}" required/>
          </div>
          <div class="form-group">
            <label>Author</label>
            <input type="text" id="editAuthor" value="${book.author}" required/>
          </div>
          <div class="form-group">
            <label>ISBN</label>
            <input type="text" id="editIsbn" value="${book.isbn}" required/>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="editDescription">${book.description || ''}</textarea>
          </div>
          <button type="submit" class="btn-primary" style="width:100%;">Save</button>
        </form>
      `;
      document.getElementById('editBookForm').onsubmit = async function(e) {
        e.preventDefault();
        window.BookRentalUtils.showLoading();
        try {
          await window.BookRentalAPI.updateBook(book.id, {
            title: document.getElementById('editTitle').value,
            author: document.getElementById('editAuthor').value,
            isbn: document.getElementById('editIsbn').value,
            description: document.getElementById('editDescription').value,
            user_id: book.user_id
          });
          window.BookRentalUtils.showToast('Book updated!', 'success');
          renderBookDetail();
        } catch (err) {
          window.BookRentalUtils.showToast(err.message || 'Update failed', 'error');
        } finally {
          window.BookRentalUtils.hideLoading();
        }
      };
    }

    // Handle delete
    async function handleDelete(bookId) {
      if (!confirm('Are you sure you want to delete this book?')) return;
      window.BookRentalUtils.showLoading();
      try {
        await window.BookRentalAPI.deleteBook(bookId);
        window.BookRentalUtils.showToast('Book deleted!', 'success');
        window.location.href = 'books.html';
      } catch (err) {
        window.BookRentalUtils.showToast(err.message || 'Delete failed', 'error');
      } finally {
        window.BookRentalUtils.hideLoading();
      }
    }

    // Show transfer form
    function showTransferForm(bookId) {
      const bookActions = document.getElementById('bookActions');
      bookActions.innerHTML = `
        <form id="transferForm" class="form-card" style="margin-top:1rem;">
          <label for="toUserId">Transfer to User ID:</label>
          <input type="text" id="toUserId" required placeholder="Enter user ID"/>
          <button type="submit" class="btn-primary" style="width:100%;margin-top:1rem;">Transfer</button>
        </form>
      `;
      document.getElementById('transferForm').onsubmit = async function(e) {
        e.preventDefault();
        const toUserId = document.getElementById('toUserId').value.trim();
        if (!toUserId) {
          window.BookRentalUtils.showToast('User ID is required', 'error');
          return;
        }
        window.BookRentalUtils.showLoading();
        try {
          const user = JSON.parse(window.localStorage.getItem('user') || 'null');
          await window.BookRentalAPI.transferBook(bookId, {
            from_user_id: user.id,
            to_user_id: toUserId
          });
          window.BookRentalUtils.showToast('Book transferred!', 'success');
          window.location.href = 'books.html';
        } catch (err) {
          window.BookRentalUtils.showToast(err.message || 'Transfer failed', 'error');
        } finally {
          window.BookRentalUtils.hideLoading();
        }
      };
    }

    document.addEventListener('DOMContentLoaded', renderBookDetail);
  </script>
</body>
</html>
